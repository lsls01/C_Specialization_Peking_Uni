define("bundles/programming/components/ScriptTokenBox",["require","exports","module","moment","react-with-addons","underscore","bundles/naptime/handleResponse","bundles/phoenix/components/Modal","bundles/phoenix/components/OrigamiRegion","bundles/phoenix/template/models/userIdentity","bundles/verification/viewModels/verificationModule","bundles/verification/views/verificationModule","js/lib/assert","js/lib/coursera.react-intl","i18n!nls/programming","bundles/programming/api/gradedScriptTokens","bundles/programming/api/ungradedScriptTokens","css!bundles/styleguide/learnerApp/cards.css","css!bundles/programming/components/__styles__/ScriptTokenBox.css"],function(require,exports,module){"use strict";function _defaults(e,r){for(var o=Object.getOwnPropertyNames(r),t=0;t<o.length;t++){var n=o[t],i=Object.getOwnPropertyDescriptor(r,n);i&&i.configurable&&void 0===e[n]&&Object.defineProperty(e,n,i)}return e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):_defaults(t,e))}var m=function(){function defineProperties(i,n){for(var t=0;t<n.length;t++){var e=n[t];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(i,e.key,e)}}return function(e,t,n){return t&&defineProperties(e.prototype,t),n&&defineProperties(e,n),e}}(),r=function get(o,l,c){var n=!0;e:for(;n;){var t=o,a=l,s=c;n=!1,null===t&&(t=Function.prototype);var e=Object.getOwnPropertyDescriptor(t,a);if(void 0===e){var i=Object.getPrototypeOf(t);if(null===i)return void 0;o=i,l=a,c=s,n=!0,e=i=void 0;continue e}if("value"in e)return e.value;var r=e.get;if(void 0===r)return void 0;return r.call(s)}},o=require("moment"),e=require("react-with-addons"),_=require("underscore"),a=require("bundles/naptime/handleResponse"),s=require("bundles/phoenix/components/Modal"),l=require("bundles/phoenix/components/OrigamiRegion"),i=require("bundles/phoenix/template/models/userIdentity"),c=require("bundles/verification/viewModels/verificationModule"),u=require("bundles/verification/views/verificationModule"),p=require("js/lib/assert"),d=require("js/lib/coursera.react-intl"),n=d.FormattedMessage,t=require("i18n!nls/programming"),f=require("bundles/programming/api/gradedScriptTokens"),g=require("bundles/programming/api/ungradedScriptTokens");require("css!bundles/styleguide/learnerApp/cards.css"),require("css!bundles/programming/components/__styles__/ScriptTokenBox.css");var h={gradedProgramming:f,ungradedProgramming:g},v=function(d){function ScriptTokenBox(){var e=this;_classCallCheck(this,ScriptTokenBox),r(Object.getPrototypeOf(ScriptTokenBox.prototype),"constructor",this).apply(this,arguments),this.state={state:"ready",token:{},currentTime:Date.now()},this.onVerificationComplete=function(t){t&&t.hasVerified===!0?e.generateToken(e.verificationViewModel.get("verifiableId")):e.generateToken(),e.setState({isVerifying:!1})},this.onTokenNotFound=function(){e.requiresVerification()?e.setState({state:"displaying"}):e.generateToken()},this.onTokenGenerated=function(){e.loadToken()},this.onFailedTokenGeneration=function(t){e.setState({state:"error",error:t})},this.onVerificationModalClose=function(){e.setState({isVerifying:!1})},this.onReceiveToken=function(t){e.setState({state:"displaying",token:t})},this.verifyAndGenerateToken=function(t){t&&t.preventDefault(),e.requiresVerification()?(e.verificationViewModel=new c({verificationDisplay:e.props.verificationDisplay,metadata:e.props.itemMetadata}),e.verificationViewModel.on("verificationComplete",e.onVerificationComplete),e.setState({isVerifying:!0})):e.generateToken()},this.updateCurrentTime=function(){e.setState({currentTime:Date.now()})}}return _inherits(ScriptTokenBox,d),m(ScriptTokenBox,[{key:"componentDidMount",value:function componentDidMount(){var e=this.props.itemMetadata.getTypeName();this.api=h[e],p(this.api,"Unknown assignment type: "+e),this.currentTimeInterval=setInterval(this.updateCurrentTime,1e3),this.loadToken()}},{key:"componentWillUnmount",value:function componentWillUnmount(){clearInterval(this.currentTimeInterval)}},{key:"isVerifiable",value:function isVerifiable(){return this.props.verificationDisplay.shouldPromptForVerification()}},{key:"requiresVerification",value:function requiresVerification(){return this.isGraded()&&this.isVerifiable()}},{key:"loadToken",value:function loadToken(){this.setState({state:"getting"}),this.api.get(this.props.itemMetadata).then(a).then(function(e){return e.elements[0]}).then(this.onReceiveToken,this.onTokenNotFound).done()}},{key:"generateToken",value:function generateToken(e){this.setState({state:"generating"}),this.api.newToken(this.props.itemMetadata,e).then(this.onTokenGenerated,this.onFailedTokenGeneration)}},{key:"isGraded",value:function isGraded(){return"gradedProgramming"===this.props.itemMetadata.getTypeName()}},{key:"render",value:function render(){var a=this.state,c=a.state,r=a.token,d=a.currentTime,m=a.isVerifying,f=a.error,p=r&&r.expiresAt-d<=0;return e.createElement("div",{className:"rc-ScriptTokenBox well card-rich-interaction"},e.createElement("h3",{className:"head-2-text"},t("How to submit")),e.createElement("p",null,t("Copy the token below and run the submission script included in the assignment download.\n          When prompted, use your email address")," ",e.createElement("b",null,i.get("email_address")),"."),e.createElement("div",{className:"token-area bt3-text-center"},_(["getting","generating"]).contains(c)&&e.createElement("p",null,t("Loading token...")),_(["displaying"]).contains(c)&&e.createElement("div",null,r&&e.createElement("div",null,(!r.expiresAt||!p)&&e.createElement("h4",null,r.secret),r.expiresAt&&!p&&e.createElement("p",{className:"caption-text"},e.createElement(n,{message:t("This token expires in {expirationTime}"),expirationTime:o(r.expiresAt).fromNow(!0)})),r.expiresAt&&p&&e.createElement("p",{className:"caption-text"},t("Your token expired"))),e.createElement("p",null,e.createElement("a",{href:"#",onClick:this.verifyAndGenerateToken},t("Generate new token")))),_(["error"]).contains(c)&&e.createElement("div",null,e.createElement("p",null,e.createElement(n,{message:t("There was an error getting your token: {error}"),error:f}),"Â ",e.createElement("a",{href:"#",onClick:this.verifyAndGenerateToken},"Click here to try to get it again")))),e.createElement("p",null,t("Your submission token is unique to you and should not be shared with anyone.\n          You may submit as many times as you like.")),m&&e.createElement(s,{modalName:"Programming Assignment Token",handleClose:this.onVerificationModalClose},e.createElement("h2",{className:"head-2-text"},t("Verify to Generate Token")),e.createElement(l,{renderOnce:!0,ViewClass:u,viewOptions:{verificationViewModel:this.verificationViewModel}})))}}],[{key:"propTypes",value:{itemMetadata:e.PropTypes.object.isRequired,verificationDisplay:e.PropTypes.object.isRequired},enumerable:!0}]),ScriptTokenBox}(e.Component);module.exports=v});